<div fxLayout="row" fxLayoutGap="20px" fxLayout.xs="column">
    <sf-settings-nav fxFlex="25%" activeLink="test-order"></sf-settings-nav>
    <div fxLayout="column" fxLayoutGap="20px" fxFlex="75%" class="cards-container">
        <form #form="ngForm">
            <div fxLayout="column" fxLayoutGap="20px" fxLayout.xl="row" fxLayoutGap.xl="20px">
                <mat-card class="order-extras" fxFlex.xl="25%" fxFlex="100%">
                    <mat-card-content fxLayout="row wrap" fxLayout.xl="column" fxLayoutGap="25px">

                        <mat-form-field appearance="outline" color="accent">
                            <mat-label i18n>Channel</mat-label>
                            <input type="text" matInput [matAutocomplete]="auto" [formControl]="channelControl"
                                   required>


                            <mat-autocomplete #auto="matAutocomplete" (optionSelected)="selectChannel($event)"
                                              [displayWith]="channelDisplayFn">
                                <ng-container *ngIf="filteredChannels && filteredNewChannels; else loading">
                                    <mat-option *ngFor="let channel of filteredChannels" [value]="channel">
                                        {{channel.name}}
                                    </mat-option>
                                    <mat-option *ngIf="!filteredChannels.length" disabled i18n>No channels found</mat-option>

                                    <mat-divider></mat-divider>
                                    <mat-option *ngFor="let channel of filteredNewChannels" [value]="channel">
                                        {{channel.name}}
                                    </mat-option>
                                    <mat-option *ngIf="!filteredNewChannels.length" disabled i18n>No channels found</mat-option>
                                </ng-container>
                                <ng-template #loading>
                                    <mat-option i18n>Loading...</mat-option>
                                </ng-template>
                            </mat-autocomplete>
                        </mat-form-field>

                        <mat-form-field appearance="outline" color="accent">
                            <mat-label i18n>Payment</mat-label>
                            <input matInput name="payment" [(ngModel)]="order.payment.method"
                                   *ngIf="paymentInputMode === 'custom'" #paymentMethod>
                            <mat-select (selectionChange)="setPaymentMethod($event)"
                                        *ngIf="paymentInputMode === 'predefined'" value="Shipped by merchant"
                                        i18n-value>
                                <mat-option i18n value="Shipped by merchant" i18n-value>Shipped by merchant</mat-option>
                                <mat-option i18n value="FBA" *ngIf="order.channelId === channelMap.amazon">
                                    FBA
                                </mat-option>
                                <mat-option i18n value="CLogistique" *ngIf="order.channelId === channelMap.cdiscount">
                                    CLogistique
                                </mat-option>
                                <mat-option i18n value="EPMM" *ngIf="order.channelId === channelMap.monechelle">
                                    EPMM
                                </mat-option>
                                <mat-option i18n value="custom">Set custom</mat-option>
                            </mat-select>
                        </mat-form-field>

                        <mat-form-field appearance="outline" color="accent">
                            <mat-label i18n>Carrier</mat-label>
                            <input matInput name="carrier" [(ngModel)]="order.shipment.carrier"
                                   (change)="changeCarrier()">
                        </mat-form-field>

                        <mat-form-field appearance="outline" color="accent">
                            <mat-label i18n>Relay number</mat-label>
                            <input matInput name="trackingNumber" [(ngModel)]="order.shipment.trackingNumber"
                                   [disabled]="!order.shipment.carrier">
                        </mat-form-field>

                    </mat-card-content>
                </mat-card>
                <mat-card fxFlex.lg="75%" fxFlex="100%">
                    <mat-card-content>
                        <table>
                            <tr>
                                <th i18n required>SKU</th>
                                <th i18n>Qty</th>
                                <th i18n required>Price</th>
                                <th>
                                    <button mat-button class="add-item" (click)="addItem()" matTooltip="Add line"
                                    i18n-matTooltip matTooltipPosition="above" type="button">
                                        <mat-icon class="mat-18">add</mat-icon>
                                    </button>
                                </th>
                            </tr>
                            <tr *ngFor="let item of order.items; index as i">
                                <td>
                                    <mat-form-field color="accent">
                                        <input name="itemReference{{i}}" matInput [(ngModel)]="item.reference" required
                                               #itemReference="ngModel">
                                        <mat-error
                                                *ngIf="itemReference.invalid && (itemReference.dirty || itemReference.touched)"
                                                i18n>
                                            Please, specify SKU
                                        </mat-error>
                                    </mat-form-field>
                                </td>
                                <td>
                                    <mat-form-field color="accent">
                                        <input type="number" name="itemQuantity{{i}}" matInput #quantity="ngModel"
                                               [(ngModel)]="item.quantity" sfMinNumber="1" min="1"
                                               (invalidValueSet)="item.quantity = 1; updateTotalPrice()"
                                               (change)="updateTotalPrice()">
                                    </mat-form-field>
                                </td>
                                <td>
                                    <mat-form-field color="accent">
                                        <input name="itemPrice{{i}}" matInput type="number" [(ngModel)]="item.price"
                                               (change)="updateTotalPrice()" required sfMinNumber="1" min="1"
                                               #itemPrice="ngModel"
                                               (invalidValueSet)="item.price = 1; updateTotalPrice()">
                                        <mat-error *ngIf="itemPrice.invalid && (itemPrice.dirty || itemPrice.touched)"
                                                   i18n>
                                            Please, specify price
                                        </mat-error>
                                    </mat-form-field>
                                </td>
                                <td>
                                    <button mat-button class="add-item" type="button"
                                            (click)="removeItem(i); updateTotalPrice();">
                                        <mat-icon class="mat-18">remove</mat-icon>
                                    </button>
                                </td>
                            </tr>
                            <tr class="totals">
                                <td>
                                    <div>
                                        <div i18n>Product total</div>
                                        <div i18n>Delivery cost</div>
                                        <div i18n class="mat-body-2">Total</div>
                                    </div>
                                </td>
                                <td>
                                </td>
                                <td>
                                    <div>
                                        <div>{{productsTotal}}</div>
                                        <mat-form-field color="accent"><input type="number"
                                                               #shippingCost="ngModel"
                                                               matInput name="shippingCost"
                                                               (change)="updateTotalPrice()"
                                                               sfMinNumber="0"
                                                               min="0"
                                                               (invalidValueSet)="order.payment.shippingAmount = 0; updateTotalPrice()"
                                                               [(ngModel)]="order.payment.shippingAmount">
                                        </mat-form-field>
                                        <div class="mat-body-2">{{totalPrice}}</div>
                                    </div>
                                </td>
                                <td></td>
                            </tr>
                        </table>
                    </mat-card-content>
                </mat-card>
            </div>
            <div fxLayout="row" fxLayoutAlign="flex-end center" class="buttons">
                <button type="reset" mat-button color="accent" i18n (click)="reset()">Cancel</button>
                <button mat-raised-button color="accent" i18n (click)="create()">Create</button>
            </div>
        </form>
    </div>
</div>